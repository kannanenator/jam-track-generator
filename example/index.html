<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal Vamp Jam Track Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="range"] {
            padding: 0;
            height: 40px;
        }

        .tempo-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-top: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #generateBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #generateBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        #generateBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #stopBtn {
            background: #f44336;
            color: white;
        }

        #stopBtn:hover:not(:disabled) {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4);
        }

        #stopBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .chord-progression {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chord {
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chord-tabs {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .chord-diagram {
            text-align: center;
        }

        .chord-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .chord-grid {
            display: inline-block;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 5px;
            background: white;
        }

        .chord-strings {
            display: flex;
            gap: 8px;
        }

        .chord-string {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .string-label {
            font-size: 10px;
            font-weight: bold;
            color: #666;
        }

        .fret {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
        }

        .fret.pressed {
            background: #667eea;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }

        .fret.open {
            background: white;
            border: 2px solid #4caf50;
            border-radius: 50%;
        }

        .fret.muted {
            color: #f44336;
            font-weight: bold;
            font-size: 16px;
            border: none;
            background: transparent;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .status.playing {
            background: #4caf50;
            color: white;
        }

        .status.stopped {
            background: #9e9e9e;
            color: white;
        }

        .status.error {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∏ Modal Vamp Jam Generator</h1>
        <p class="subtitle">Create looping chord progressions for jamming</p>

        <div id="loading" class="loading">
            Loading WASM module...
        </div>

        <div id="controls" class="hidden">
            <div class="control-group">
                <label for="keySelect">Key</label>
                <select id="keySelect">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#" selected>F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
            </div>

            <div class="control-group">
                <label for="modeSelect">Mode</label>
                <select id="modeSelect">
                    <option value="Ionian">Ionian (Major)</option>
                    <option value="Dorian">Dorian</option>
                    <option value="Phrygian" selected>Phrygian</option>
                    <option value="Lydian">Lydian</option>
                    <option value="Mixolydian">Mixolydian</option>
                    <option value="Aeolian">Aeolian (Minor)</option>
                    <option value="Locrian">Locrian</option>
                </select>
            </div>

            <div class="control-group">
                <label for="tempoSlider">Tempo</label>
                <input type="range" id="tempoSlider" min="60" max="200" value="150" step="1">
                <div class="tempo-display"><span id="tempoValue">150</span> BPM</div>
            </div>

            <div class="button-group">
                <button id="generateBtn">‚ñ∂Ô∏è Generate & Play</button>
                <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
            </div>

            <div id="status" class="status stopped">Ready to generate</div>

            <div id="infoBox" class="info-box hidden">
                <h3>Chord Progression:</h3>
                <div id="chordProgression" class="chord-progression"></div>
                <div id="chordTabs" class="chord-tabs"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, {
            JamTrackConfig,
            JamTrackGenerator,
            get_available_keys,
            get_available_modes
        } from './pkg/jam_track_generator.js';

        let audioContext = null;
        let sourceNode = null;
        let generator = null;

        const keySelect = document.getElementById('keySelect');
        const modeSelect = document.getElementById('modeSelect');
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoValue = document.getElementById('tempoValue');
        const generateBtn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const infoBox = document.getElementById('infoBox');
        const chordProgression = document.getElementById('chordProgression');
        const chordTabs = document.getElementById('chordTabs');
        const loading = document.getElementById('loading');
        const controls = document.getElementById('controls');

        // Update tempo display
        tempoSlider.addEventListener('input', (e) => {
            tempoValue.textContent = e.target.value;
        });

        // Initialize WASM
        async function initWasm() {
            try {
                await init();
                console.log('WASM module loaded successfully');
                loading.classList.add('hidden');
                controls.classList.remove('hidden');
            } catch (err) {
                console.error('Failed to load WASM module:', err);
                loading.textContent = 'Error loading WASM module: ' + err.message;
            }
        }

        // Generate and play audio
        async function generateAndPlay() {
            try {
                // Initialize audio context on first user interaction
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Stop any currently playing audio
                stopAudio();

                // Update status
                updateStatus('Generating...', 'stopped');
                generateBtn.disabled = true;

                // Get configuration
                const key = keySelect.value;
                const mode = modeSelect.value;
                const tempo = parseFloat(tempoSlider.value);

                console.log(`Generating track: ${key} ${mode} @ ${tempo} BPM`);

                // Create configuration
                const config = new JamTrackConfig(key, mode, tempo);

                // Create generator
                generator = new JamTrackGenerator(config);

                // Get chord progression info
                const progressionJson = generator.get_progression_info();
                const chords = JSON.parse(progressionJson);
                displayChordProgression(chords);

                // Get and display chord tabs
                const tabsJson = generator.get_chord_tabs();
                const tabs = JSON.parse(tabsJson);
                displayChordTabs(tabs);

                // Generate samples
                const samples = generator.generate_samples();
                const sampleRate = generator.sample_rate();
                const duration = generator.duration();

                console.log(`Generated ${samples.length} samples at ${sampleRate} Hz (${duration}s)`);

                // Create audio buffer
                const audioBuffer = audioContext.createBuffer(1, samples.length, sampleRate);
                const channelData = audioBuffer.getChannelData(0);

                // Copy samples to buffer
                for (let i = 0; i < samples.length; i++) {
                    channelData[i] = samples[i];
                }

                // Create and start source node with looping
                sourceNode = audioContext.createBufferSource();
                sourceNode.buffer = audioBuffer;
                sourceNode.loop = true;
                sourceNode.connect(audioContext.destination);
                sourceNode.start(0);

                // Update UI
                updateStatus('Playing (looping)', 'playing');
                generateBtn.disabled = false;
                stopBtn.disabled = false;

            } catch (err) {
                console.error('Error generating audio:', err);
                updateStatus('Error: ' + err.message, 'error');
                generateBtn.disabled = false;
            }
        }

        // Stop audio playback
        function stopAudio() {
            if (sourceNode) {
                try {
                    sourceNode.stop();
                } catch (e) {
                    // Ignore if already stopped
                }
                sourceNode.disconnect();
                sourceNode = null;
            }
            updateStatus('Stopped', 'stopped');
            stopBtn.disabled = true;
        }

        // Update status display
        function updateStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Display chord progression
        function displayChordProgression(chords) {
            chordProgression.innerHTML = '';
            chords.forEach(chord => {
                const chordEl = document.createElement('div');
                chordEl.className = 'chord';
                chordEl.textContent = chord;
                chordProgression.appendChild(chordEl);
            });
            infoBox.classList.remove('hidden');
        }

        // Draw a single chord diagram
        function drawChordDiagram(chordTab) {
            if (!chordTab) return null;

            const diagram = document.createElement('div');
            diagram.className = 'chord-diagram';

            const chordName = document.createElement('div');
            chordName.className = 'chord-name';
            chordName.textContent = chordTab.name;
            diagram.appendChild(chordName);

            const grid = document.createElement('div');
            grid.className = 'chord-grid';

            const strings = document.createElement('div');
            strings.className = 'chord-strings';

            const stringNames = ['E', 'A', 'D', 'G', 'B', 'E'];
            const numFrets = 5;

            // Draw each string
            chordTab.fingers.forEach((fretNum, stringIndex) => {
                const stringDiv = document.createElement('div');
                stringDiv.className = 'chord-string';

                // String label
                const label = document.createElement('div');
                label.className = 'string-label';
                label.textContent = stringNames[stringIndex];
                stringDiv.appendChild(label);

                // Draw frets
                if (fretNum === -1) {
                    // Muted string
                    const fret = document.createElement('div');
                    fret.className = 'fret muted';
                    fret.textContent = '√ó';
                    stringDiv.appendChild(fret);
                } else if (fretNum === 0) {
                    // Open string
                    const fret = document.createElement('div');
                    fret.className = 'fret open';
                    fret.textContent = '‚óã';
                    stringDiv.appendChild(fret);
                } else {
                    // Fretted notes
                    for (let i = 1; i <= numFrets; i++) {
                        const fret = document.createElement('div');
                        fret.className = 'fret';
                        if (i === fretNum) {
                            fret.classList.add('pressed');
                            fret.textContent = i;
                        }
                        stringDiv.appendChild(fret);
                    }
                }

                strings.appendChild(stringDiv);
            });

            grid.appendChild(strings);
            diagram.appendChild(grid);

            return diagram;
        }

        // Display chord tabs
        function displayChordTabs(tabs) {
            chordTabs.innerHTML = '';
            tabs.forEach(tab => {
                const diagram = drawChordDiagram(tab);
                if (diagram) {
                    chordTabs.appendChild(diagram);
                }
            });
        }

        // Event listeners
        generateBtn.addEventListener('click', generateAndPlay);
        stopBtn.addEventListener('click', stopAudio);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAudio();
            if (audioContext) {
                audioContext.close();
            }
        });

        // Initialize
        initWasm();
    </script>
</body>
</html>
